<div class="container my-4">

  <div class="card shadow-sm border-0">
    <div class="card-body">
      <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb mb-0">
      
          <li class="breadcrumb-item text-muted">
            Dashboard
          </li>
      
          <li *ngIf="isEditMode" class="breadcrumb-item text-muted">
            Select Form
          </li>
      
          <li class="breadcrumb-item active fw-semibold" aria-current="page">
            {{ isEditMode ? 'Edit Form' : 'Create Form' }}
          </li>
      
        </ol>
      </nav>

      <div class="d-flex justify-content-between align-items-center mb-4  sticky-top bg-white py-3">

        <h3 class="fw-bold text-primary mb-0">
          {{ isEditMode ? 'Edit Dynamic Form' : 'Create Dynamic Form' }}
        </h3>
      
        <button
          mat-stroked-button
          color="primary"
          [routerLink]="isEditMode ? '/fill-form' : '/dashboard'">
          <mat-icon class="me-1">arrow_back</mat-icon> 
          {{ isEditMode ? 'Back to Form List' : 'Back to Dashboard' }}
        </button>
      
      </div>


      <form [formGroup]="formBuilderForm">

        <!-- ================= FORM HEADER ================= -->
        <div class="row g-3 mb-4">

          <div class="col-md-3">
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Form Title</mat-label>
              <input matInput formControlName="formTitle">
              <mat-error *ngIf="formBuilderForm.get('formTitle')?.touched &&
                                formBuilderForm.get('formTitle')?.hasError('required')">
                Form Title is required
              </mat-error>
            </mat-form-field>
          </div>

          <div class="col-md-9">
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Form Description</mat-label>
              <input matInput formControlName="formDescription">
              <mat-error *ngIf="formBuilderForm.get('formDescription')?.touched &&
                                formBuilderForm.get('formDescription')?.hasError('required')">
                Form Description is required
              </mat-error>
            </mat-form-field>
          </div>

        </div>

        <!-- ================= QUESTIONS ================= -->
        <div formArrayName="fields">

          <div *ngFor="let field of fields.controls; let i = index">

            <div *ngIf="field.get('isActive')?.value !== false" [formGroupName]="i"
              class="card mb-4 shadow-sm border-0">

              <div class="card-body">

                <h6 class="text-secondary mb-3">
                  Question {{ i + 1 }}
                </h6>

                <!-- Question + Type -->
                <div class="row g-3">

                  <div class="col-md-12">
                    <mat-form-field appearance="outline" class="w-100">
                      <mat-label>Question</mat-label>
                      <input matInput formControlName="label">
                      <mat-error *ngIf="field.get('label')?.touched && field.get('label')?.invalid">
                        Question is required
                      </mat-error>
                    </mat-form-field>
                  </div>

                  <div class="col-md-3">
                    <mat-form-field appearance="outline" class="w-100">
                      <mat-label>Field Type</mat-label>
                      <mat-select formControlName="type">
                        <mat-option *ngFor="let t of fieldTypes" [value]="t.value">
                          {{ t.label }}
                        </mat-option>
                      </mat-select>
                      <mat-error *ngIf="field.get('type')?.touched && field.get('type')?.invalid">
                        Type is required
                      </mat-error>
                    </mat-form-field>
                  </div>
                  <div class="col-md-3" *ngIf="field.get('type')?.value === 'text'">
                    <mat-form-field appearance="outline" class="w-100">
                      <mat-label>Default Value</mat-label>
                      <input matInput formControlName="defaultValue">
                    </mat-form-field>
                  </div>
                  <div class="col-md-1 d-flex align-items-center">
                    <mat-checkbox formControlName="required">
                      Required
                    </mat-checkbox>
                  </div>
                </div>

                <!-- ================= OPTIONS ================= -->
                <div *ngIf="showOptions(i)" formArrayName="options" class="border rounded p-3 mt-3 bg-light">

                  <h6 class="text-secondary mb-3">Options</h6>

                  <div *ngFor="let opt of getOptionsControls(i); let j = index" [formGroupName]="j"
                    class="row g-3 mb-2">

                    <div class="col-md-4">
                      <mat-form-field appearance="outline" class="w-100">
                        <mat-label>Option</mat-label>
                        <input matInput formControlName="value">
                        <mat-error *ngIf="opt.get('value')?.touched &&
                                          opt.get('value')?.hasError('required')">
                          Option value is required
                        </mat-error>
                      </mat-form-field>
                    </div>

                    <div class="col-md-1 d-flex align-items-center" *ngIf="field.get('type')?.value !== 'radio'">
                      <mat-checkbox formControlName="isDefault" (change)="onDefaultOptionChange(i, j)">
                        Default
                      </mat-checkbox>
                    </div>

                    <div class="ms-3 col-md-1 d-flex align-items-center">
                      <button mat-icon-button color="warn" (click)="removeOption(i, j)">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                  </div>

                  <button mat-stroked-button color="primary" class="mt-2" (click)="addOption(i)">
                    + Add Option
                  </button>

                </div>

                <!-- ================= CONDITIONS ================= -->
                <div class="border rounded p-3 mt-4 bg-white" [formGroup]="formBuilderForm">

                  <div formArrayName="conditions">

                    <h6 class="text-warning mb-3">Conditions</h6>

                    <ng-container *ngFor="let cond of conditions.controls; let c = index">

                      <div *ngIf="cond.get('isActive')?.value !== false &&
                                  (
                                    (cond.get('targetFieldId')?.value &&
                                     cond.get('targetFieldId')?.value === field.get('fieldId')?.value)
                                    ||
                                    (cond.get('targetFieldIndex')?.value === i)
                                  )" [formGroupName]="c"
                        class="row g-3 mb-3 border-start border-4 border-warning ps-3">

                        <!-- Source Field -->
                        <div class="col-md-3">
                          <mat-form-field appearance="outline" class="w-100">
                            <mat-label>Source Field</mat-label>
                            <mat-select [value]="getSourceFieldValue(c)" [compareWith]="compareSourceFields"
                              (selectionChange)="onSourceFieldChange($event.value, c)">
                              <mat-option *ngFor="let f of fields.controls; let fi = index"
                                [value]="{ id: f.get('fieldId')?.value || 0, index: fi }" [disabled]="fi === i">
                                {{ f.get('label')?.value || ('Question ' + (fi + 1)) }}
                              </mat-option>
                            </mat-select>
                          </mat-form-field>
                        </div>

                        <!-- Operator -->
                        <div class="col-md-2">
                          <mat-form-field appearance="outline" class="w-100">
                            <mat-label>Operator</mat-label>
                            <mat-select formControlName="operator">
                              <mat-option *ngFor="let op of conditionOperators" [value]="op.value">
                                {{ op.label }}
                              </mat-option>
                            </mat-select>
                          </mat-form-field>
                        </div>

                        <!-- Comparison -->
                        <div class="col-md-3">
                          <mat-form-field appearance="outline" class="w-100">
                            <mat-label>Comparison Value</mat-label>
                            <input matInput formControlName="comparisonValue">
                          </mat-form-field>
                        </div>

                        <!-- Action -->
                        <div class="col-md-2">
                          <mat-form-field appearance="outline" class="w-100">
                            <mat-label>Action</mat-label>
                            <mat-select formControlName="action">
                              <mat-option *ngFor="let a of conditionActions" [value]="a.value">
                                {{ a.label }}
                              </mat-option>
                            </mat-select>
                          </mat-form-field>
                        </div>

                        <!-- Delete -->
                        <div class="col-md-1 d-flex align-items-center">
                          <button mat-icon-button color="warn" (click)="removeCondition(c)">
                            <mat-icon>delete</mat-icon>
                          </button>
                        </div>
                      </div>

                    </ng-container>

                    <button mat-stroked-button color="primary" (click)="addCondition(i)">
                      + Add Condition
                    </button>

                  </div>
                </div>

                <!-- Remove Question -->
                <div class="text-end mt-3">
                  <button mat-stroked-button color="warn" (click)="removeField(i)">
                    Remove Question
                  </button>
                </div>

              </div>
            </div>

          </div>
        </div>

        <!-- Final 2 buttons -->
        <div class="d-flex justify-content-between mt-4">
          <button mat-raised-button color="primary" (click)="addField()">
            + Add Question
          </button>

          <button mat-raised-button color="accent" (click)="saveForm()">
            Save Form
          </button>
        </div>

      </form>

    </div>
  </div>

</div>